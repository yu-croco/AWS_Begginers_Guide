# 1. Infrastructure as Code
インフラの（雑な）変遷と、最近話題のIaCについて紹介

*厳密さよりもイメージを持ってもらうことに注力しているので、マサカリはヤメてください

## 1-1.（雑な）歴史のお話
### それほど遠くない昔、僕らの済む銀河系で

![スターウォーズ](./mig.jpeg)

世の中の自社サービス企業は、自分たちの会社に物理サーバーを設置し、その中で必要なリソースを構築していた。
そう、自社内で以下のようなことを全てやっていたのである。

- 物理インフラの選定（スペック、購入台数などなど）
- 物理インフラの設置（ネットワーク工事の対応、配線、各種ソフトウェアのインストール、セキュリティ対策などなど）
- 物理インフラのメンテ（在庫管理、ソフトウェアのアップデート、冗長化対応などなど）
- サーバー（物理インフラ上で動くソフトウェア）の構築
- サーバー（物理インフラ上で動くソフトウェア）の運用

もちろんこの時代にはほとんどの作業が人の手によって運用されていた。
しかもそこに自動化なんてものはほぼ存在しない。運良く手順書が残っていれば御の字、というものであった。

つまり、特定の人以外誰も社内のサーバーの事情を把握していないし、触れないのである。
しかもサーバーを自前で保有しているので、固定費としても馬鹿にならない。

#### この時代でのツラミ
- 物理インフラそものを固定費として社内で保持しないといけない
- 物理インフラの構築
- サーバーの構築
- 物理インフラの運用
- サーバーの運用

### ほんの10年くらい前の話
そんな荒廃したインフラの世界に、AWSが名を知らしめ始めていた（AWSは2011年頃に日本のRegionを発表）。
どうもAWSというのは、クラウドインフラなるものを提供しているらしい。

クラウドインフラだと

- 必要な分だけサーバーをすぐさま手配できる
  - 社内で固定サーバー不要！
- サーバーを減らしたり増やしたりするのもすぐにできる
  - いつでも手放せる！
- 使った分だけの費用が請求される
  - サラバ、社内の物理サーバー！

らしい。

まさに銀の弾丸ではなかろうか！

こうして世のテック企業は続々と、このクラウドインフラの世界に足を踏み入れていった。

さて、AWS上で自社のサービスを展開し始めた企業は、webコンソール上からポチポチとマウスを動かすことで手軽にサーバーのリソースを確保出来るようになり、サービス構築の手間が格段に減った。
今までのあの苦労は一体何だったんだろう、という気持ちだ。

ただ一方で雲行きが怪しい一面も出てきた。

物理インフラの調達管理からは開放されたが、サーバーの構築/運用面での煩雑さは依然として残っていたのだ。
いくらAWSが仮想環境を手軽に提供してくれるようになったとはいえ、ソレを使って自社のアプリケーションを管理するのは依然として自社エンジニアがスべき仕事である。

要は、サーバーの構築（サーバーそのものと、その上に乗っかるアプリケーションのインストール）と運用（アップデートなど）は自分たちでやらないといけない。

そのため多くのテック企業では、EC2インスタンスへsshログインし、その中で各種ソフトウェアのアップデートを行うのだ。しかも所有するサーバーの台数分だけ同じことをする。新しいインスタンスやサービスを立ち上げる度に、インフラエンジニアは手順書（もしそんなのが社内に残っていたとするならばの話だが！）に沿ってweb画面からポチポチと設定をしてサーバーのセットアップをするのである。

かくして、インフラのリソース確保は楽になったが、運用は相変わらず地獄であった。

#### この時代でのツラミ
- ~~物理インフラそものを固定費として社内で保持しないといけない~~
- ~~物理インフラのセットアップ~~
- サーバーのセットアップ
- ~~物理インフラの運用~~
- サーバーの運用

### 6年くらい前から最近
これじゃあいつまで経っても楽にならねーということで、世の中の強いエンジニアたちは叡智を集結させて[Chef](https://www.chef.io/)/[Ansible](https://www.ansible.com/)/[Terraform](https://www.terraform.io/)などの、インフラの構成管理ツール（しかもOSS！）を世にリリースしたのだった。

これらのツールの役目は、

- コードでインフラのリソースを管理すること
- またそのソースコードを用いて環境の構築などを実行すること

であった。

アプリケーションコードのようにコードで管理できれば、各リソースの現状が把握でき、環境の横展開や変更がいともたやすくできてしまう、というわけだ。

これがいわゆる`Infrastructure as Code (IaC)`のおおまかな流れである。

### 近年
最近はというと、「そもそもサーバーの管理すらしたくない」という流れが出てきて`サーバーレス`なるものも流行りつつある。
AWSでいうところのLambdaがそれに当たる。

サーバー管理に当たる一切のことをクラウドベンダーに任せ、利用者は動かしたいアプリケーションコードを記載するだけで済む、という代物だ。

まさに銀の弾丸のように聞こえるが、現実はそううまくいかない。

AWS Lambdaに限って言うと、DataBaseとのコネクションプール問題（随分改善はされてきている）などの問題や、そもそもLambdaの思想との乖離があるので、結局の所は `組織での合意次第`と行ったところがあると思う。

そういうわけで、インフラエンジニアの戦いはまだ続くのであった...

## 1-2. IaCでの重要な考え方
### リソースのコード化
`IaC`の名前そのままだが、コードとしてインフラリソースを管理することが何よりも基本となってくる。
コレをしなければ結局は旧世代の手運用と変わらないのだから。

とは言うものの、「では、利用するリソースを全て完璧にコードで管理するべきか？」という点では議論の余地がある。

検証用などでスポットで立ち上げるリソースのためにわざわざコードで管理するのは面倒なのが正直なところである。
GenKanのインフラに関して言うと、メインのアプリケーションを稼働させる構成は確実にコードに落とし込んでいるが、それ以外のところは割と自由にやっている。

そのため組織毎にルールを設け、それに沿っていくのがよいと思われる。

### 自動化
人の手を介すところに不具合は現れる（インフラの障害の内結構な割合は手動作業の際に発生するらしい）ので、基本的には自動化することが望ましい。
コード化したリソースを実際に適応するのはCI/CDの機構に載せるなどの対応がある。

### Immutable性
インフラリソースをコードで管理するということは、インフラリソースはコードに記載された情報をそのまま反映しなければならない。
そのため、「一度コード化をしたが、その後は手動でインフラリソースを変更している」というのはよろしくない。

基本的には構成管理ツールを用いて、コードとインフラリソースの対応が一致するようにすべきである。

また、クラウドインフラはいくらでもスクラップアンドビルド可能である（費用は使った時間やリソースの量に対して発生するのであり、スクラップアンドビルドそのものにより追加費用が発生することは基本的には無い）。

そのため、`リソースに変更や不具合があれば、新しいリソースを作って差し替える（今動いているリソースにこだわらない）`という考え方を持っておくと良い。

「クラウドインフラはペットではなく、家畜のように扱え」といったような言葉もあるくらいである。

*要は、愛情込めて一つのリソースを育ててはならないということ。

#### 参考
- [クラウドは家畜の群れだ。ペットのようにかわいがるな！](https://blogs.itmedia.co.jp/narisako/2014/07/post-047f.html)

## 1-3. IaC周りのツール
このレポジトリでは、主に以下の２つの技術スタックを用いることで、IaCを進めている。

### [Terraform](https://www.terraform.io/)
- HashiCorp社が提供しているOSS
- AWS上に展開するリソース構成をコードで管理できる
- 次の章から使っていく

### [Docker](https://www.docker.com/)
- Docker社が提供しているOSS
- インフラそのものではないが、インフラの上で動くことになるアプリケーションの設定をコードで管理することが出来る

### 参考
- [Infrastructure as Code(wikipedia)](https://ja.wikipedia.org/wiki/Infrastructure_as_Code#:~:text=Infrastructure%20as%20Code%EF%BC%88IaC%EF%BC%89%20%E3%81%AF,%E4%BF%9D%E6%8C%81%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%82%82%E3%81%82%E3%82%8B%E3%80%82)
- [【DevOps 用語集】Infrastructure as Code（IaC）【2019年12月27日更新】](https://licensecounter.jp/devops-hub/blog/IaC/)
- [【DevOps 用語集】Immutable Infrastructure【2019年12月27日更新】](https://licensecounter.jp/devops-hub/blog/Immutable/)
